<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Variance Analysis Tool</title>
  <link rel="stylesheet" href="/frontend/styles.css?v=4" />
</head>
<body>
  <header>
    <div class="header-main">
      <img src="/frontend/assets/logo.png" alt="Logo" class="logo" />
      <h1 data-i18n="title">AI Variance Analysis Tool</h1>
      <div class="lang-toggle" role="tablist" aria-label="Language">
        <button id="lang-en" class="btn small active" role="tab" aria-selected="true">EN</button>
        <button id="lang-vi" class="btn small" role="tab" aria-selected="false">VI</button>
      </div>
    </div>
    <p class="subtitle" data-i18n="subtitle">Upload Excel → AI Analyzes → Download Results</p>
  </header>

  <main>
    <!-- LEFT: upload + AI info -->
    <section class="card" aria-labelledby="uploadRunHdr">
      <h2 id="uploadRunHdr" data-i18n="uploadRun">Upload & Process</h2>

      <div class="field">
        <label for="excel" data-i18n="excelLabel">Excel file(s)</label>
        <input id="excel" type="file" accept=".xlsx" multiple title=".xlsx" aria-describedby="excelHelp" />
        <div id="excelHelp" class="help" data-i18n="excelHelp">Select one or more .xlsx files for AI analysis</div>
      </div>

      <div class="ai-info-section">
        <h3 class="section-title" data-i18n="aiInfoTitle">🤖 AI-Powered Analysis</h3>
        <div class="ai-features">
          <div class="feature-item">
            <span class="icon">🧠</span>
            <div>
              <strong data-i18n="autoMateriality">Auto Materiality Detection</strong>
              <p data-i18n="autoMaterialityDesc">AI determines significance thresholds based on company size and data patterns</p>
            </div>
          </div>
          <div class="feature-item">
            <span class="icon">🔍</span>
            <div>
              <strong data-i18n="smartFocus">Smart Focus Areas</strong>
              <p data-i18n="smartFocusDesc">Prioritizes Revenue, Utilities, and Interest Rate analysis automatically</p>
            </div>
          </div>
          <div class="feature-item">
            <span class="icon">📝</span>
            <div>
              <strong data-i18n="detailedExplanations">Detailed Explanations</strong>
              <p data-i18n="detailedExplanationsDesc">Every anomaly includes reasoning and business context</p>
            </div>
          </div>
        </div>
      </div>

      <div class="progress-container" id="progressContainer" style="display: none;">
        <h3 class="section-title">🤖 AI Analysis Progress</h3>

        <!-- Progress Bar -->
        <div class="progress-bar-wrapper">
          <div class="progress-bar" style="background: #e5e7eb; height: 24px; border-radius: 12px; overflow: hidden;">
            <div class="progress-fill" id="progressFill" style="height: 100%; background: linear-gradient(90deg, #3b82f6, #1d4ed8); border-radius: 12px; transition: width 0.5s ease; width: 0%;"></div>
          </div>
          <div class="progress-percentage" id="progressPercentage" style="font-weight: bold; color: #1e40af; font-size: 18px; min-width: 50px; text-align: center; background: #f0f9ff; padding: 4px 8px; border-radius: 8px;">0%</div>
        </div>

        <!-- Progress Stages -->
        <div class="progress-stages">
          <div class="stage" id="stage-upload">
            <div class="stage-icon">📤</div>
            <div class="stage-text">Upload</div>
          </div>
          <div class="stage" id="stage-analyze">
            <div class="stage-icon">🧠</div>
            <div class="stage-text">AI Analysis</div>
          </div>
          <div class="stage" id="stage-generate">
            <div class="stage-icon">📊</div>
            <div class="stage-text">Generate Report</div>
          </div>
          <div class="stage" id="stage-complete">
            <div class="stage-icon">✅</div>
            <div class="stage-text">Complete</div>
          </div>
        </div>

        <!-- Current Status -->
        <div class="current-status" id="currentStatus">
          <span class="status-text">Preparing analysis...</span>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <button id="runBtn" class="btn primary" data-i18n="processBtn">🚀 Analyze with AI</button>
      </div>
    </section>

    <!-- RIGHT: explanations and info -->
    <section class="card">
      <h2 data-i18n="howItWorks">How AI Analysis Works</h2>

      <div class="info-section">
        <h3 data-i18n="step1Title">📊 Step 1: Data Analysis</h3>
        <p data-i18n="step1Desc">AI examines your financial data to understand company size, account patterns, and business context</p>
      </div>

      <div class="info-section">
        <h3 data-i18n="step2Title">🎯 Step 2: Smart Thresholds</h3>
        <p data-i18n="step2Desc">Automatically determines materiality thresholds and focuses on critical areas: Revenue, Utilities, Interest Rates</p>
      </div>

      <div class="info-section">
        <h3 data-i18n="step3Title">🔍 Step 3: Anomaly Detection</h3>
        <p data-i18n="step3Desc">Identifies unusual patterns, variance issues, and accounting inconsistencies with detailed explanations</p>
      </div>

      <div class="info-section">
        <h3 data-i18n="step4Title">📋 Step 4: Detailed Report</h3>
        <p data-i18n="step4Desc">Generates Excel report with specific findings, business reasoning, and recommended actions</p>
      </div>

      <div class="download-section" id="downloadSection" style="display: none;">
        <h3 data-i18n="downloadTitle">📥 Download Results</h3>
      </div>
    </section>
  </main>

  <script>
    const translations = {
      "en": {
        title: "AI Variance Analysis Tool",
        subtitle: "Upload Excel → AI Analyzes → Download Results",
        uploadRun: "Upload & Process",
        excelLabel: "Excel file(s)",
        excelHelp: "Select one or more .xlsx files for AI analysis",
        aiInfoTitle: "🤖 AI-Powered Analysis",
        autoMateriality: "Auto Materiality Detection",
        autoMaterialityDesc: "AI determines significance thresholds based on company size and data patterns",
        smartFocus: "Smart Focus Areas",
        smartFocusDesc: "Prioritizes Revenue, Utilities, and Interest Rate analysis automatically",
        detailedExplanations: "Detailed Explanations",
        detailedExplanationsDesc: "Every anomaly includes reasoning and business context",
        processBtn: "🚀 Analyze with AI",
        idle: "Ready",
        response: "Analysis Progress",
        howItWorks: "How AI Analysis Works",
        step1Title: "📊 Step 1: Data Analysis",
        step1Desc: "AI examines your financial data to understand company size, account patterns, and business context",
        step2Title: "🎯 Step 2: Smart Thresholds",
        step2Desc: "Automatically determines materiality thresholds and focuses on critical areas: Revenue, Utilities, Interest Rates",
        step3Title: "🔍 Step 3: Anomaly Detection",
        step3Desc: "Identifies unusual patterns, variance issues, and accounting inconsistencies with detailed explanations",
        step4Title: "📋 Step 4: Detailed Report",
        step4Desc: "Generates Excel report with specific findings, business reasoning, and recommended actions",
        downloadTitle: "📥 Download Results",
        downloadBtn: "Download Analysis"
      },
      "vi": {
        title: "Công Cụ Phân Tích Sai Lệch AI",
        subtitle: "Tải Excel → AI Phân Tích → Tải Kết Quả",
        uploadRun: "Tải Lên & Xử Lý",
        excelLabel: "Tệp Excel",
        excelHelp: "Chọn một hoặc nhiều tệp .xlsx để AI phân tích",
        aiInfoTitle: "🤖 Phân Tích Bằng AI",
        autoMateriality: "Tự Động Phát Hiện Mức Trọng Yếu",
        autoMaterialityDesc: "AI xác định ngưỡng quan trọng dựa trên quy mô công ty và mẫu dữ liệu",
        smartFocus: "Lĩnh Vực Tập Trung Thông Minh",
        smartFocusDesc: "Ưu tiên phân tích Doanh thu, Tiện ích và Lãi suất tự động",
        detailedExplanations: "Giải Thích Chi Tiết",
        detailedExplanationsDesc: "Mỗi bất thường bao gồm lý do và bối cảnh kinh doanh",
        processBtn: "🚀 Phân Tích với AI",
        idle: "Sẵn Sàng",
        response: "Tiến Trình Phân Tích",
        howItWorks: "Cách AI Phân Tích Hoạt Động",
        step1Title: "📊 Bước 1: Phân Tích Dữ Liệu",
        step1Desc: "AI kiểm tra dữ liệu tài chính để hiểu quy mô công ty, mẫu tài khoản và bối cảnh kinh doanh",
        step2Title: "🎯 Bước 2: Ngưỡng Thông Minh",
        step2Desc: "Tự động xác định ngưỡng trọng yếu và tập trung vào các lĩnh vực quan trọng: Doanh thu, Tiện ích, Lãi suất",
        step3Title: "🔍 Bước 3: Phát Hiện Bất Thường",
        step3Desc: "Xác định các mẫu bất thường, vấn đề sai lệch và không nhất quán kế toán với giải thích chi tiết",
        step4Title: "📋 Bước 4: Báo Cáo Chi Tiết",
        step4Desc: "Tạo báo cáo Excel với các phát hiện cụ thể, lý do kinh doanh và hành động khuyến nghị",
        downloadTitle: "📥 Tải Kết Quả",
        downloadBtn: "Tải Phân Tích"
      }
    };

    let currentLang = "en";
    function switchLanguage(lang) {
      currentLang = lang;
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if (translations[lang][key]) {
          el.textContent = translations[lang][key];
        }
      });

      document.querySelectorAll(".btn.small").forEach(btn => btn.classList.remove("active"));
      document.getElementById(`lang-${lang}`).classList.add("active");
    }

    document.getElementById("lang-en").onclick = () => switchLanguage("en");
    document.getElementById("lang-vi").onclick = () => switchLanguage("vi");

    // Initialize
    switchLanguage("en");
  </script>

  <script>
    console.log("🚀 INLINE SCRIPT EXECUTING!");

    document.addEventListener("DOMContentLoaded", () => {
      console.log("✅ DOM LOADED!");
      const runBtn = document.getElementById("runBtn");

      if (runBtn) {
        runBtn.addEventListener("click", function(event) {
          event.preventDefault();

          const excelInput = document.getElementById("excel");
          if (!excelInput?.files?.length) {
            alert("Please select at least one Excel file");
            return;
          }

          const progressContainer = document.getElementById("progressContainer");
          if (progressContainer) {
            progressContainer.style.display = "block";
          }

          runBtn.disabled = true;
          runBtn.innerHTML = '🔄 Processing...';

          const fd = new FormData();
          for (const file of excelInput.files) {
            fd.append("excel_files", file);
          }

          fetch('/start_analysis', { method: "POST", body: fd })
            .then(response => response.json())
            .then(data => {
              runBtn.innerHTML = '🤖 AI Analyzing...';

              const eventSource = new EventSource(`/logs/${data.session_id}`);

              function updateProgress(percentage, stage, statusText) {
                const progressFill = document.getElementById("progressFill");
                const progressPercentage = document.getElementById("progressPercentage");
                const currentStatus = document.getElementById("currentStatus");

                if (progressFill) {
                  progressFill.style.width = percentage + "%";
                }
                if (progressPercentage) {
                  progressPercentage.textContent = percentage + "%";
                }
                if (currentStatus && statusText) {
                  const statusElement = currentStatus.querySelector('.status-text');
                  if (statusElement) {
                    statusElement.textContent = statusText;
                  }
                }

                // Update stage indicators
                const stages = ['upload', 'analyze', 'generate', 'complete'];
                stages.forEach((stageName) => {
                  const stageEl = document.getElementById("stage-" + stageName);
                  if (stageEl) {
                    stageEl.classList.remove('active', 'completed');

                    if (stageName === stage) {
                      stageEl.classList.add('active');
                    } else if (stages.indexOf(stageName) < stages.indexOf(stage)) {
                      stageEl.classList.add('completed');
                    }
                  }
                });
              }

              eventSource.onmessage = function(event) {
                const logData = JSON.parse(event.data);

                if (logData.type === 'progress') {
                  let stage = 'upload';
                  if (logData.percentage >= 25 && logData.percentage < 85) {
                    stage = 'analyze';
                    runBtn.innerHTML = '🧠 AI Analyzing...';
                  } else if (logData.percentage >= 85 && logData.percentage < 100) {
                    stage = 'generate';
                    runBtn.innerHTML = '📊 Generating Report...';
                  } else if (logData.percentage >= 100) {
                    stage = 'complete';
                  }

                  updateProgress(logData.percentage, stage, logData.message);
                } else if (logData.type === 'complete') {
                  updateProgress(100, 'complete', 'Analysis completed successfully!');
                  runBtn.innerHTML = '✅ Complete!';
                  eventSource.close();

                  // Show download section
                  const downloadSection = document.getElementById("downloadSection");
                  if (downloadSection) {
                    downloadSection.style.display = "block";

                    // Add main download button if not already present
                    if (!downloadSection.querySelector('.main-download-btn')) {
                      const mainDownloadBtn = document.createElement("button");
                      mainDownloadBtn.className = "btn primary main-download-btn";
                      mainDownloadBtn.innerHTML = "📊 Download Analysis Results";
                      mainDownloadBtn.style.marginBottom = "10px";
                      mainDownloadBtn.onclick = () => downloadMainResult(data.session_id);

                      const downloadTitle = downloadSection.querySelector('h3');
                      if (downloadTitle) {
                        downloadTitle.parentNode.insertBefore(mainDownloadBtn, downloadTitle.nextSibling);
                      }
                    }
                  }
                } else if (logData.type === 'error') {
                  updateProgress(0, 'upload', 'Error: ' + logData.message);
                  runBtn.innerHTML = '❌ Error';
                  eventSource.close();
                }
              };
            })
            .catch(error => {
              alert("Error: " + error.message);
              runBtn.disabled = false;
              runBtn.innerHTML = '🚀 Analyze with AI';
            });
        });
      }

      // Download function
      window.downloadMainResult = async function(sessionId) {
        try {
          const response = await fetch(`/download/${sessionId}`);
          if (!response.ok) {
            throw new Error(`Download failed: ${response.status}`);
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `ai_variance_analysis_${sessionId}.xlsx`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } catch (error) {
          alert("Download failed: " + error.message);
        }
      };
    });
  </script>
</body>
</html>