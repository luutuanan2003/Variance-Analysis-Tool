<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Variance Analysis Tool</title>
  <link rel="stylesheet" href="/frontend/styles.css?v=2" />
</head>
<body>
  <script>
    // Initialize language system immediately
    const dict = {
      en: {
        title: "Variance Analysis Tool",
        subtitle: "Upload Excel ‚Üí Process ‚Üí Download",
        uploadRun: "Upload & Run",
        excelLabel: "Excel file(s)",
        excelHelp: "Select one or more .xlsx files",
        mappingLabel: "Mapping (optional)",
        mappingHelp: "Correlation/Seasonality rules workbook (optional)",
        materiality: "Materiality (VND)",
        materialityHelp: "Absolute change threshold in VND (applies to many rules).",
        recurringPct: "Recurring %",
        recurringPctHelp: "MoM % threshold for recurring P/L accounts (e.g., 635*, 515*).",
        revenuePct: "Revenue/OPEX %",
        revenuePctHelp: "MoM % threshold for revenue & operating expense accounts.",
        bsPct: "Balance Sheet %",
        bsPctHelp: "MoM % threshold for BS balances (also gated by materiality).",
        prefixes: "Recurring code prefixes",
        prefixesHelp: "Comma or | separated (defines which P/L codes are 'Recurring').",
        minTrend: "Min trend periods",
        minTrendHelp: "Min periods to compute simple trend context in the output.",
        processBtn: "Process",
        idle: "Idle",
        uploading: "Uploading‚Ä¶",
        processing: "Processing‚Ä¶",
        done: "Done",
        failed: "Failed",
        noFilesYet: "No files yet.",
        noExcelSelected: "Please choose at least one .xlsx file.",
        response: "Response",
        downloadThisRun: "Download (this run)",
        gmDropLabel: "gm_drop_threshold_pct",
        gmDropHelp: "Alert when Gross Margin % drops ‚â• this (absolute points).",
        depPctLabel: "dep_pct_only_prefixes",
        depPctHelp: "Codes that use %-only rule for depreciation variance.",
        pctNote: "Tip: You can enter 0.05, 5, or 5% ‚Äî they all mean 5%.",
        revenueResultsTitle: "Revenue Analysis Results",
        clearLog: "Clear Log"
      },
      vi: {
        title: "C√¥ng c·ª• ph√¢n t√≠ch bi·∫øn ƒë·ªông",
        subtitle: "T·∫£i Excel ‚Üí X·ª≠ l√Ω ‚Üí T·∫£i xu·ªëng",
        uploadRun: "T·∫£i t·ªáp & Ch·∫°y",
        excelLabel: "T·ªáp Excel",
        excelHelp: "Ch·ªçn m·ªôt ho·∫∑c nhi·ªÅu t·ªáp .xlsx",
        mappingLabel: "T·ªáp quy t·∫Øc (t√πy ch·ªçn)",
        mappingHelp: "T·ªáp quy t·∫Øc T∆∞∆°ng quan/M√πa v·ª• (t√πy ch·ªçn)",
        materiality: "Ng∆∞·ª°ng quan tr·ªçng (VND)",
        materialityHelp: "Ng∆∞·ª°ng bi·∫øn ƒë·ªông tuy·ªát ƒë·ªëi theo VND (√°p d·ª•ng cho nhi·ªÅu lu·∫≠t).",
        recurringPct: "% ƒê·ªãnh k·ª≥",
        recurringPctHelp: "Ng∆∞·ª°ng % MoM cho c√°c t√†i kho·∫£n P/L ƒë·ªãnh k·ª≥ (vd: 635*, 515*).",
        revenuePct: "% Doanh thu/Chi ph√≠",
        revenuePctHelp: "Ng∆∞·ª°ng % MoM cho doanh thu & chi ph√≠ ho·∫°t ƒë·ªông.",
        bsPct: "% B·∫£ng CƒêKT",
        bsPctHelp: "Ng∆∞·ª°ng % MoM cho s·ªë d∆∞ CƒêKT (c√≥ ki·ªÉm so√°t b·ªüi ng∆∞·ª°ng VND).",
        prefixes: "Ti·ªÅn t·ªë m√£ ƒë·ªãnh k·ª≥",
        prefixesHelp: "NgƒÉn c√°ch b·∫±ng d·∫•u ph·∫©y ho·∫∑c | (ƒë·ªãnh nghƒ©a nh√≥m P/L 'ƒê·ªãnh k·ª≥').",
        minTrend: "S·ªë k·ª≥ t·ªëi thi·ªÉu",
        minTrendHelp: "S·ªë k·ª≥ t·ªëi thi·ªÉu ƒë·ªÉ t√≠nh xu h∆∞·ªõng ƒë∆°n gi·∫£n trong k·∫øt qu·∫£.",
        processBtn: "X·ª≠ l√Ω",
        idle: "Ch·ªù",
        uploading: "ƒêang t·∫£i‚Ä¶",
        processing: "ƒêang x·ª≠ l√Ω‚Ä¶",
        done: "Ho√†n t·∫•t",
        failed: "L·ªói",
        noFilesYet: "Ch∆∞a c√≥ t·ªáp.",
        noExcelSelected: "Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt t·ªáp .xlsx.",
        response: "Ph·∫£n h·ªìi",
        downloadThisRun: "T·∫£i xu·ªëng (l∆∞·ª£t n√†y)",
        gmDropLabel: "Ng∆∞·ª°ng gi·∫£m GM (%)",
        gmDropHelp: "C·∫£nh b√°o khi GM% gi·∫£m ‚â• ng∆∞·ª°ng n√†y (ƒëi·ªÉm % tuy·ªát ƒë·ªëi).",
        depPctLabel: "M√£ kh·∫•u hao (%-only)",
        depPctHelp: "C√°c m√£ √°p d·ª•ng lu·∫≠t ch·ªâ theo % cho ch√™nh l·ªách kh·∫•u hao.",
        pctNote: "M·∫πo: B·∫°n c√≥ th·ªÉ nh·∫≠p 0.05, 5 ho·∫∑c 5% ‚Äî ƒë·ªÅu l√† 5%.",
        revenueResultsTitle: "K·∫øt qu·∫£ ph√¢n t√≠ch doanh thu",
        clearLog: "X√≥a nh·∫≠t k√Ω"
      }
    };

    // Make everything globally available immediately
    window.dict = dict;

    // Language switching function - available immediately
    window.setLang = function(lang) {
      console.log('üîÑ Language switching to:', lang);

      const strings = dict[lang] || dict.en;

      // Update all elements with data-i18n
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if (strings[key]) {
          el.textContent = strings[key];
        }
      });

      // Update button states
      const enBtn = document.getElementById("lang-en");
      const viBtn = document.getElementById("lang-vi");

      if (enBtn && viBtn) {
        enBtn.classList.remove("active");
        viBtn.classList.remove("active");

        if (lang === "en") {
          enBtn.classList.add("active");
          enBtn.setAttribute("aria-selected", "true");
          viBtn.setAttribute("aria-selected", "false");
        } else {
          viBtn.classList.add("active");
          viBtn.setAttribute("aria-selected", "true");
          enBtn.setAttribute("aria-selected", "false");
        }
      }

      document.documentElement.setAttribute("lang", lang);

      // Visual confirmation
      const title = document.querySelector('[data-i18n="title"]');
      if (title) {
        console.log('‚úÖ Title updated to:', title.textContent);
      }
    }

    console.log('Language system loaded');
  </script>
  <header>
    <div class="header-main">
      <img src="/frontend/assets/logo.png" alt="Logo" class="logo" />
      <h1 data-i18n="title">Variance Analysis Tool</h1>
      <div class="lang-toggle" role="tablist" aria-label="Language">
        <button id="lang-en" class="btn small active" role="tab" aria-selected="true" onclick="console.log('EN clicked'); window.setLang('en')">EN</button>
        <button id="lang-vi" class="btn small" role="tab" aria-selected="false" onclick="console.log('VI clicked'); window.setLang('vi')">VI</button>
      </div>
    </div>
    <p class="subtitle" data-i18n="subtitle">Upload Excel ‚Üí Process ‚Üí Download</p>
  </header>

  <main>
    <!-- LEFT: upload + config -->
    <section class="card" aria-labelledby="uploadRunHdr">
      <h2 id="uploadRunHdr" data-i18n="uploadRun">Upload & Run</h2>

      <div class="field">
        <label for="excel" data-i18n="excelLabel">Excel file(s)</label>
        <input id="excel" type="file" accept=".xlsx" multiple title=".xlsx" aria-describedby="excelHelp" />
        <div id="excelHelp" class="help" data-i18n="excelHelp">Select one or more .xlsx files</div>
      </div>

      <div class="field">
        <label for="mapping" data-i18n="mappingLabel">Mapping (optional)</label>
        <input id="mapping" type="file" accept=".xlsx" aria-describedby="mappingHelp" />
        <div id="mappingHelp" class="help" data-i18n="mappingHelp">Correlation/Seasonality rules workbook (optional)</div>
      </div>

      <div class="sep"></div>

      <div class="grid-2" role="group" aria-labelledby="configHdr">
        <h3 id="configHdr" class="visually-hidden">Configuration</h3>

        <div class="field">
          <label for="materiality_vnd" data-i18n="materiality">Materiality (VND)</label>
          <input id="materiality_vnd" type="number" placeholder="1000000000" inputmode="numeric" />
          <div class="help" data-i18n="materialityHelp">Absolute change threshold in VND (applies to many rules).</div>
        </div>

        <div class="field">
          <label for="recurring_pct_threshold" data-i18n="recurringPct">Recurring %</label>
          <input id="recurring_pct_threshold" type="text" placeholder="0.05 or 5%" aria-describedby="pctNote" />
          <div class="help" data-i18n="recurringPctHelp">MoM % threshold for recurring P/L accounts (e.g., 635*, 515*).</div>
        </div>

        <div class="field">
          <label for="revenue_opex_pct_threshold" data-i18n="revenuePct">Revenue/OPEX %</label>
          <input id="revenue_opex_pct_threshold" type="text" placeholder="0.10 or 10%" aria-describedby="pctNote" />
          <div class="help" data-i18n="revenuePctHelp">MoM % threshold for revenue & operating expense accounts.</div>
        </div>

        <div class="field">
          <label for="bs_pct_threshold" data-i18n="bsPct">Balance Sheet %</label>
          <input id="bs_pct_threshold" type="text" placeholder="0.05 or 5%" aria-describedby="pctNote" />
          <div class="help" data-i18n="bsPctHelp">MoM % threshold for BS balances (also gated by materiality).</div>
        </div>

        <div class="field">
          <label for="recurring_code_prefixes" data-i18n="prefixes">Recurring code prefixes</label>
          <input id="recurring_code_prefixes" type="text" placeholder="6321,635,515" />
          <div class="help" data-i18n="prefixesHelp">Comma or | separated (defines which P/L codes are ‚ÄúRecurring‚Äù).</div>
        </div>

        <div class="field">
          <label for="min_trend_periods" data-i18n="minTrend">Min trend periods</label>
          <input id="min_trend_periods" type="number" placeholder="3" inputmode="numeric" />
          <div class="help" data-i18n="minTrendHelp">Min periods to compute simple trend context in the output.</div>
        </div>

        <div class="field">
          <label for="gm_drop_threshold_pct" data-i18n="gmDropLabel">gm_drop_threshold_pct</label>
          <input id="gm_drop_threshold_pct" type="text" placeholder="0.01 or 1%" aria-describedby="pctNote" />
          <div class="help" data-i18n="gmDropHelp">Alert when Gross Margin % drops ‚â• this (absolute points).</div>
        </div>

        <div class="field">
          <label for="dep_pct_only_prefixes" data-i18n="depPctLabel">dep_pct_only_prefixes</label>
          <input id="dep_pct_only_prefixes" type="text" placeholder="217,632" />
          <div class="help" data-i18n="depPctHelp">Codes that use %-only rule for depreciation variance.</div>
        </div>


        <div id="pctNote" class="help" style="grid-column: 1 / -1;" data-i18n="pctNote">
          Tip: You can enter 0.05, 5, or 5% ‚Äî they all mean 5%.
        </div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <button id="runBtn" class="btn primary" data-i18n="processBtn">Process</button>
        <span id="liveStatus" class="pill" data-i18n="idle">Idle</span>
      </div>

      <div class="field" style="margin-top:12px;">
        <label for="response" data-i18n="response">Response</label>
        <div id="response" class="status" aria-live="polite"></div>
        <!-- Clear Log button is injected by JS -->
      </div>
    </section>

    <!-- RIGHT: download files and revenue analysis results -->
    <section class="card" aria-labelledby="outputsHdr">
      <h2 id="outputsHdr" data-i18n="downloadThisRun">Download (this run)</h2>
      <ul id="files" class="files" aria-live="polite"></ul>

      <div class="sep"></div>

      <div id="revenueResults" style="display: none;" class="revenue-results-section">
        <h3 data-i18n="revenueResultsTitle" class="revenue-results-title">Revenue Analysis Results</h3>
        <div id="revenueContent" class="revenue-analysis-content"></div>
      </div>
    </section>
  </main>

  <script>
    // Initialize default language on page load
    document.addEventListener("DOMContentLoaded", () => {
      window.setLang("en");
    });
  </script>

  <!-- Bump cache-buster when script changes -->
  <script src="/frontend/script.js?v=3" defer></script>
</body>
</html>
