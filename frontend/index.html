<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Merged Variance Analysis Tool</title>
  <link rel="stylesheet" href="/frontend/styles.css?v=6" />
</head>
<body>
  <script>
    // Initialize language system immediately
    const dict = {
      en: {
        title: "Merged Variance Analysis Tool",
        subtitle: "Choose your analysis approach: Manual Python rules or AI-powered analysis",
        pythonTab: "Python Analysis",
        aiTab: "AI Analysis",
        uploadRun: "Upload & Run",
        excelLabel: "Excel file(s)",
        excelHelp: "Select one or more .xlsx files",
        mappingLabel: "Mapping (optional)",
        mappingHelp: "Correlation/Seasonality rules workbook (optional)",
        materiality: "Materiality (VND)",
        materialityHelp: "Absolute change threshold in VND (applies to many rules).",
        recurringPct: "Recurring %",
        recurringPctHelp: "MoM % threshold for recurring P/L accounts (e.g., 635*, 515*).",
        revenuePct: "Revenue/OPEX %",
        revenuePctHelp: "MoM % threshold for revenue & operating expense accounts.",
        bsPct: "Balance Sheet %",
        bsPctHelp: "MoM % threshold for BS balances (also gated by materiality).",
        prefixes: "Recurring code prefixes",
        prefixesHelp: "Comma or | separated (defines which P/L codes are 'Recurring').",
        minTrend: "Min trend periods",
        minTrendHelp: "Min periods to compute simple trend context in the output.",
        processBtn: "Process",
        idle: "Idle",
        uploading: "Uploading‚Ä¶",
        processing: "Processing‚Ä¶",
        done: "Done",
        failed: "Failed",
        noFilesYet: "No files yet.",
        noExcelSelected: "Please choose at least one .xlsx file.",
        response: "Response",
        downloadThisRun: "Download (this run)",
        gmDropLabel: "gm_drop_threshold_pct",
        gmDropHelp: "Alert when Gross Margin % drops ‚â• this (absolute points).",
        depPctLabel: "dep_pct_only_prefixes",
        depPctHelp: "Codes that use %-only rule for depreciation variance.",
        pctNote: "Tip: You can enter 0.05, 5, or 5% ‚Äî they all mean 5%.",
        revenueResultsTitle: "Revenue Analysis Results",
        clearLog: "Clear Log",
        // AI Analysis specific
        aiInfoTitle: "ü§ñ AI-Powered Analysis",
        autoMateriality: "Auto Materiality Detection",
        autoMaterialityDesc: "AI determines significance thresholds based on company size and data patterns",
        smartFocus: "Smart Focus Areas",
        smartFocusDesc: "Prioritizes Revenue, Utilities, and Interest Rate analysis automatically",
        detailedExplanations: "Detailed Explanations",
        detailedExplanationsDesc: "Every anomaly includes reasoning and business context",
        aiProcessBtn: "üöÄ Analyze with AI",
        howItWorks: "How AI Analysis Works",
        step1Title: "üìä Step 1: Data Analysis",
        step1Desc: "AI examines your financial data to understand company size, account patterns, and business context",
        step2Title: "üéØ Step 2: Smart Thresholds",
        step2Desc: "Automatically determines materiality thresholds and focuses on critical areas: Revenue, Utilities, Interest Rates",
        step3Title: "üîç Step 3: Anomaly Detection",
        step3Desc: "Identifies unusual patterns, variance issues, and accounting inconsistencies with detailed explanations",
        step4Title: "üìã Step 4: Detailed Report",
        step4Desc: "Generates Excel report with specific findings, business reasoning, and recommended actions",
        downloadTitle: "üì• Download Results"
      },
      vi: {
        title: "C√¥ng c·ª• ph√¢n t√≠ch bi·∫øn ƒë·ªông t·ªïng h·ª£p",
        subtitle: "Ch·ªçn ph∆∞∆°ng ph√°p ph√¢n t√≠ch: Quy t·∫Øc Python th·ªß c√¥ng ho·∫∑c ph√¢n t√≠ch b·∫±ng AI",
        pythonTab: "Ph√¢n t√≠ch Python",
        aiTab: "Ph√¢n t√≠ch AI",
        uploadRun: "T·∫£i t·ªáp & Ch·∫°y",
        excelLabel: "T·ªáp Excel",
        excelHelp: "Ch·ªçn m·ªôt ho·∫∑c nhi·ªÅu t·ªáp .xlsx",
        mappingLabel: "T·ªáp quy t·∫Øc (t√πy ch·ªçn)",
        mappingHelp: "T·ªáp quy t·∫Øc T∆∞∆°ng quan/M√πa v·ª• (t√πy ch·ªçn)",
        materiality: "Ng∆∞·ª°ng quan tr·ªçng (VND)",
        materialityHelp: "Ng∆∞·ª°ng bi·∫øn ƒë·ªông tuy·ªát ƒë·ªëi theo VND (√°p d·ª•ng cho nhi·ªÅu lu·∫≠t).",
        recurringPct: "% ƒê·ªãnh k·ª≥",
        recurringPctHelp: "Ng∆∞·ª°ng % MoM cho c√°c t√†i kho·∫£n P/L ƒë·ªãnh k·ª≥ (vd: 635*, 515*).",
        revenuePct: "% Doanh thu/Chi ph√≠",
        revenuePctHelp: "Ng∆∞·ª°ng % MoM cho doanh thu & chi ph√≠ ho·∫°t ƒë·ªông.",
        bsPct: "% B·∫£ng CƒêKT",
        bsPctHelp: "Ng∆∞·ª°ng % MoM cho s·ªë d∆∞ CƒêKT (c√≥ ki·ªÉm so√°t b·ªüi ng∆∞·ª°ng VND).",
        prefixes: "Ti·ªÅn t·ªë m√£ ƒë·ªãnh k·ª≥",
        prefixesHelp: "NgƒÉn c√°ch b·∫±ng d·∫•u ph·∫©y ho·∫∑c | (ƒë·ªãnh nghƒ©a nh√≥m P/L 'ƒê·ªãnh k·ª≥').",
        minTrend: "S·ªë k·ª≥ t·ªëi thi·ªÉu",
        minTrendHelp: "S·ªë k·ª≥ t·ªëi thi·ªÉu ƒë·ªÉ t√≠nh xu h∆∞·ªõng ƒë∆°n gi·∫£n trong k·∫øt qu·∫£.",
        processBtn: "X·ª≠ l√Ω",
        idle: "Ch·ªù",
        uploading: "ƒêang t·∫£i‚Ä¶",
        processing: "ƒêang x·ª≠ l√Ω‚Ä¶",
        done: "Ho√†n t·∫•t",
        failed: "L·ªói",
        noFilesYet: "Ch∆∞a c√≥ t·ªáp.",
        noExcelSelected: "Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt t·ªáp .xlsx.",
        response: "Ph·∫£n h·ªìi",
        downloadThisRun: "T·∫£i xu·ªëng (l∆∞·ª£t n√†y)",
        gmDropLabel: "Ng∆∞·ª°ng gi·∫£m GM (%)",
        gmDropHelp: "C·∫£nh b√°o khi GM% gi·∫£m ‚â• ng∆∞·ª°ng n√†y (ƒëi·ªÉm % tuy·ªát ƒë·ªëi).",
        depPctLabel: "M√£ kh·∫•u hao (%-only)",
        depPctHelp: "C√°c m√£ √°p d·ª•ng lu·∫≠t ch·ªâ theo % cho ch√™nh l·ªách kh·∫•u hao.",
        pctNote: "M·∫πo: B·∫°n c√≥ th·ªÉ nh·∫≠p 0.05, 5 ho·∫∑c 5% ‚Äî ƒë·ªÅu l√† 5%.",
        revenueResultsTitle: "K·∫øt qu·∫£ ph√¢n t√≠ch doanh thu",
        clearLog: "X√≥a nh·∫≠t k√Ω",
        // AI Analysis specific - Vietnamese
        aiInfoTitle: "ü§ñ Ph√¢n t√≠ch b·∫±ng AI",
        autoMateriality: "T·ª± ƒë·ªông ph√°t hi·ªán m·ª©c tr·ªçng y·∫øu",
        autoMaterialityDesc: "AI x√°c ƒë·ªãnh ng∆∞·ª°ng quan tr·ªçng d·ª±a tr√™n quy m√¥ c√¥ng ty v√† m·∫´u d·ªØ li·ªáu",
        smartFocus: "Lƒ©nh v·ª±c t·∫≠p trung th√¥ng minh",
        smartFocusDesc: "∆Øu ti√™n ph√¢n t√≠ch Doanh thu, Ti·ªán √≠ch v√† L√£i su·∫•t t·ª± ƒë·ªông",
        detailedExplanations: "Gi·∫£i th√≠ch chi ti·∫øt",
        detailedExplanationsDesc: "M·ªói b·∫•t th∆∞·ªùng bao g·ªìm l√Ω do v√† b·ªëi c·∫£nh kinh doanh",
        aiProcessBtn: "üöÄ Ph√¢n t√≠ch v·ªõi AI",
        howItWorks: "C√°ch AI ph√¢n t√≠ch ho·∫°t ƒë·ªông",
        step1Title: "üìä B∆∞·ªõc 1: Ph√¢n t√≠ch d·ªØ li·ªáu",
        step1Desc: "AI ki·ªÉm tra d·ªØ li·ªáu t√†i ch√≠nh ƒë·ªÉ hi·ªÉu quy m√¥ c√¥ng ty, m·∫´u t√†i kho·∫£n v√† b·ªëi c·∫£nh kinh doanh",
        step2Title: "üéØ B∆∞·ªõc 2: Ng∆∞·ª°ng th√¥ng minh",
        step2Desc: "T·ª± ƒë·ªông x√°c ƒë·ªãnh ng∆∞·ª°ng tr·ªçng y·∫øu v√† t·∫≠p trung v√†o c√°c lƒ©nh v·ª±c quan tr·ªçng: Doanh thu, Ti·ªán √≠ch, L√£i su·∫•t",
        step3Title: "üîç B∆∞·ªõc 3: Ph√°t hi·ªán b·∫•t th∆∞·ªùng",
        step3Desc: "X√°c ƒë·ªãnh c√°c m·∫´u b·∫•t th∆∞·ªùng, v·∫•n ƒë·ªÅ sai l·ªách v√† kh√¥ng nh·∫•t qu√°n k·∫ø to√°n v·ªõi gi·∫£i th√≠ch chi ti·∫øt",
        step4Title: "üìã B∆∞·ªõc 4: B√°o c√°o chi ti·∫øt",
        step4Desc: "T·∫°o b√°o c√°o Excel v·ªõi c√°c ph√°t hi·ªán c·ª• th·ªÉ, l√Ω do kinh doanh v√† h√†nh ƒë·ªông khuy·∫øn ngh·ªã",
        downloadTitle: "üì• T·∫£i k·∫øt qu·∫£"
      }
    };

    // Make everything globally available immediately
    window.dict = dict;

    // Language switching function - available immediately
    window.setLang = function(lang) {
      console.log('üîÑ Language switching to:', lang);

      const strings = dict[lang] || dict.en;

      // Update all elements with data-i18n
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if (strings[key]) {
          el.textContent = strings[key];
        }
      });

      // Update button states
      const enBtn = document.getElementById("lang-en");
      const viBtn = document.getElementById("lang-vi");

      if (enBtn && viBtn) {
        enBtn.classList.remove("active");
        viBtn.classList.remove("active");

        if (lang === "en") {
          enBtn.classList.add("active");
          enBtn.setAttribute("aria-selected", "true");
          viBtn.setAttribute("aria-selected", "false");
        } else {
          viBtn.classList.add("active");
          viBtn.setAttribute("aria-selected", "true");
          enBtn.setAttribute("aria-selected", "false");
        }
      }

      document.documentElement.setAttribute("lang", lang);

      // Visual confirmation
      const title = document.querySelector('[data-i18n="title"]');
      if (title) {
        console.log('‚úÖ Title updated to:', title.textContent);
      }
    }

    console.log('Language system loaded');
  </script>

  <header>
    <div class="header-main">
      <img src="/frontend/assets/logo.png" alt="Logo" class="logo" />
      <h1 data-i18n="title">Merged Variance Analysis Tool</h1>
      <div class="lang-toggle" role="tablist" aria-label="Language">
        <button id="lang-en" class="btn small active" role="tab" aria-selected="true" onclick="console.log('EN clicked'); window.setLang('en')">EN</button>
        <button id="lang-vi" class="btn small" role="tab" aria-selected="false" onclick="console.log('VI clicked'); window.setLang('vi')">VI</button>
      </div>
    </div>
    <p class="subtitle" data-i18n="subtitle">Choose your analysis approach: Manual Python rules or AI-powered analysis</p>
  </header>

  <main>
    <!-- TAB NAVIGATION -->
    <div class="tab-navigation">
      <button class="tab-btn active" data-tab="python" data-i18n="pythonTab">Python Analysis</button>
      <button class="tab-btn" data-tab="ai" data-i18n="aiTab">AI Analysis</button>
    </div>

    <!-- PYTHON ANALYSIS TAB -->
    <div id="python-tab" class="tab-content active">
      <div class="tab-layout">
        <!-- LEFT: upload + config -->
        <section class="card" aria-labelledby="uploadRunHdr">
          <h2 id="uploadRunHdr" data-i18n="uploadRun">Upload & Run</h2>

          <div class="field">
            <label for="python-excel" data-i18n="excelLabel">Excel file(s)</label>
            <input id="python-excel" type="file" accept=".xlsx" multiple title=".xlsx" aria-describedby="excelHelp" />
            <div id="excelHelp" class="help" data-i18n="excelHelp">Select one or more .xlsx files</div>
          </div>

          <div class="field">
            <label for="mapping" data-i18n="mappingLabel">Mapping (optional)</label>
            <input id="mapping" type="file" accept=".xlsx" aria-describedby="mappingHelp" />
            <div id="mappingHelp" class="help" data-i18n="mappingHelp">Correlation/Seasonality rules workbook (optional)</div>
          </div>

          <div class="sep"></div>

          <div class="grid-2" role="group" aria-labelledby="configHdr">
            <h3 id="configHdr" class="visually-hidden">Configuration</h3>

            <div class="field">
              <label for="materiality_vnd" data-i18n="materiality">Materiality (VND)</label>
              <input id="materiality_vnd" type="number" placeholder="1000000000" inputmode="numeric" />
              <div class="help" data-i18n="materialityHelp">Absolute change threshold in VND (applies to many rules).</div>
            </div>

            <div class="field">
              <label for="recurring_pct_threshold" data-i18n="recurringPct">Recurring %</label>
              <input id="recurring_pct_threshold" type="text" placeholder="0.05 or 5%" aria-describedby="pctNote" />
              <div class="help" data-i18n="recurringPctHelp">MoM % threshold for recurring P/L accounts (e.g., 635*, 515*).</div>
            </div>

            <div class="field">
              <label for="revenue_opex_pct_threshold" data-i18n="revenuePct">Revenue/OPEX %</label>
              <input id="revenue_opex_pct_threshold" type="text" placeholder="0.10 or 10%" aria-describedby="pctNote" />
              <div class="help" data-i18n="revenuePctHelp">MoM % threshold for revenue & operating expense accounts.</div>
            </div>

            <div class="field">
              <label for="bs_pct_threshold" data-i18n="bsPct">Balance Sheet %</label>
              <input id="bs_pct_threshold" type="text" placeholder="0.05 or 5%" aria-describedby="pctNote" />
              <div class="help" data-i18n="bsPctHelp">MoM % threshold for BS balances (also gated by materiality).</div>
            </div>

            <div class="field">
              <label for="recurring_code_prefixes" data-i18n="prefixes">Recurring code prefixes</label>
              <input id="recurring_code_prefixes" type="text" placeholder="6321,635,515" />
              <div class="help" data-i18n="prefixesHelp">Comma or | separated (defines which P/L codes are "Recurring").</div>
            </div>

            <div class="field">
              <label for="min_trend_periods" data-i18n="minTrend">Min trend periods</label>
              <input id="min_trend_periods" type="number" placeholder="3" inputmode="numeric" />
              <div class="help" data-i18n="minTrendHelp">Min periods to compute simple trend context in the output.</div>
            </div>

            <div class="field">
              <label for="gm_drop_threshold_pct" data-i18n="gmDropLabel">gm_drop_threshold_pct</label>
              <input id="gm_drop_threshold_pct" type="text" placeholder="0.01 or 1%" aria-describedby="pctNote" />
              <div class="help" data-i18n="gmDropHelp">Alert when Gross Margin % drops ‚â• this (absolute points).</div>
            </div>

            <div class="field">
              <label for="dep_pct_only_prefixes" data-i18n="depPctLabel">dep_pct_only_prefixes</label>
              <input id="dep_pct_only_prefixes" type="text" placeholder="217,632" />
              <div class="help" data-i18n="depPctHelp">Codes that use %-only rule for depreciation variance.</div>
            </div>

            <div id="pctNote" class="help" style="grid-column: 1 / -1;" data-i18n="pctNote">
              Tip: You can enter 0.05, 5, or 5% ‚Äî they all mean 5%.
            </div>
          </div>

          <div class="sep"></div>

          <div class="row">
            <button id="pythonRunBtn" class="btn primary" data-i18n="processBtn">Process</button>
            <span id="pythonLiveStatus" class="pill" data-i18n="idle">Idle</span>
          </div>

          <div class="field" style="margin-top:12px;">
            <label for="pythonResponse" data-i18n="response">Response</label>
            <div id="pythonResponse" class="status" aria-live="polite"></div>
          </div>
        </section>

        <!-- RIGHT: download files and revenue analysis results -->
        <section class="card" aria-labelledby="outputsHdr">
          <h2 id="outputsHdr" data-i18n="downloadThisRun">Download (this run)</h2>
          <ul id="pythonFiles" class="files" aria-live="polite"></ul>

          <div class="sep"></div>

          <div id="revenueResults" style="display: none;" class="revenue-results-section">
            <h3 data-i18n="revenueResultsTitle" class="revenue-results-title">Revenue Analysis Results</h3>
            <div id="revenueContent" class="revenue-analysis-content"></div>
          </div>
        </section>
      </div>
    </div>

    <!-- AI ANALYSIS TAB -->
    <div id="ai-tab" class="tab-content">
      <div class="tab-layout">
        <!-- LEFT: upload + AI info -->
        <section class="card" aria-labelledby="aiUploadHdr">
          <h2 id="aiUploadHdr" data-i18n="uploadRun">Upload & Process</h2>

          <div class="field">
            <label for="ai-excel" data-i18n="excelLabel">Excel file(s)</label>
            <input id="ai-excel" type="file" accept=".xlsx" multiple title=".xlsx" aria-describedby="aiExcelHelp" />
            <div id="aiExcelHelp" class="help" data-i18n="excelHelp">Select one or more .xlsx files for AI analysis</div>
          </div>

          <div class="ai-info-section">
            <h3 class="section-title" data-i18n="aiInfoTitle">ü§ñ AI-Powered Analysis</h3>
            <div class="ai-features">
              <div class="feature-item">
                <span class="icon">üß†</span>
                <div>
                  <strong data-i18n="autoMateriality">Auto Materiality Detection</strong>
                  <p data-i18n="autoMaterialityDesc">AI determines significance thresholds based on company size and data patterns</p>
                </div>
              </div>
              <div class="feature-item">
                <span class="icon">üîç</span>
                <div>
                  <strong data-i18n="smartFocus">Smart Focus Areas</strong>
                  <p data-i18n="smartFocusDesc">Prioritizes Revenue, Utilities, and Interest Rate analysis automatically</p>
                </div>
              </div>
              <div class="feature-item">
                <span class="icon">üìù</span>
                <div>
                  <strong data-i18n="detailedExplanations">Detailed Explanations</strong>
                  <p data-i18n="detailedExplanationsDesc">Every anomaly includes reasoning and business context</p>
                </div>
              </div>
            </div>
          </div>

          <div class="progress-container" id="aiProgressContainer" style="display: none;">
            <h3 class="section-title">ü§ñ AI Analysis Progress</h3>

            <!-- Progress Bar -->
            <div class="progress-bar-wrapper">
              <div class="progress-bar" style="background: #e5e7eb; height: 24px; border-radius: 12px; overflow: hidden;">
                <div class="progress-fill" id="aiProgressFill" style="height: 100%; background: linear-gradient(90deg, #3b82f6, #1d4ed8); border-radius: 12px; transition: width 0.5s ease; width: 0%;"></div>
              </div>
              <div class="progress-percentage" id="aiProgressPercentage" style="font-weight: bold; color: #1e40af; font-size: 18px; min-width: 50px; text-align: center; background: #f0f9ff; padding: 4px 8px; border-radius: 8px;">0%</div>
            </div>

            <!-- Progress Stages -->
            <div class="progress-stages">
              <div class="stage" id="ai-stage-upload">
                <div class="stage-icon">üì§</div>
                <div class="stage-text">Upload</div>
              </div>
              <div class="stage" id="ai-stage-analyze">
                <div class="stage-icon">üß†</div>
                <div class="stage-text">AI Analysis</div>
              </div>
              <div class="stage" id="ai-stage-generate">
                <div class="stage-icon">üìä</div>
                <div class="stage-text">Generate Report</div>
              </div>
              <div class="stage" id="ai-stage-complete">
                <div class="stage-icon">‚úÖ</div>
                <div class="stage-text">Complete</div>
              </div>
            </div>

            <!-- Current Status -->
            <div class="current-status" id="aiCurrentStatus">
              <span class="status-text">Preparing analysis...</span>
            </div>
          </div>

          <div class="sep"></div>

          <div class="row">
            <button id="aiRunBtn" class="btn primary" data-i18n="aiProcessBtn">üöÄ Analyze with AI</button>
          </div>
        </section>

        <!-- RIGHT: explanations and info -->
        <section class="card">
          <h2 data-i18n="howItWorks">How AI Analysis Works</h2>

          <div class="info-section">
            <h3 data-i18n="step1Title">üìä Step 1: Data Analysis</h3>
            <p data-i18n="step1Desc">AI examines your financial data to understand company size, account patterns, and business context</p>
          </div>

          <div class="info-section">
            <h3 data-i18n="step2Title">üéØ Step 2: Smart Thresholds</h3>
            <p data-i18n="step2Desc">Automatically determines materiality thresholds and focuses on critical areas: Revenue, Utilities, Interest Rates</p>
          </div>

          <div class="info-section">
            <h3 data-i18n="step3Title">üîç Step 3: Anomaly Detection</h3>
            <p data-i18n="step3Desc">Identifies unusual patterns, variance issues, and accounting inconsistencies with detailed explanations</p>
          </div>

          <div class="info-section">
            <h3 data-i18n="step4Title">üìã Step 4: Detailed Report</h3>
            <p data-i18n="step4Desc">Generates Excel report with specific findings, business reasoning, and recommended actions</p>
          </div>

          <div class="download-section" id="aiDownloadSection" style="display: none;">
            <h3 data-i18n="downloadTitle">üì• Download Results</h3>
          </div>
        </section>
      </div>
    </div>
  </main>

  <script>
    // Initialize default language on page load
    document.addEventListener("DOMContentLoaded", () => {
      window.setLang("en");

      // Initialize tab switching
      initializeTabs();

      // Initialize Python analysis functionality
      initializePythonAnalysis();

      // Initialize AI analysis functionality
      initializeAIAnalysis();
    });

    function initializeTabs() {
      const tabBtns = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');

      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const targetTab = btn.getAttribute('data-tab');

          // Remove active class from all tabs
          tabBtns.forEach(b => b.classList.remove('active'));
          tabContents.forEach(t => t.classList.remove('active'));

          // Add active class to clicked tab
          btn.classList.add('active');
          document.getElementById(targetTab + '-tab').classList.add('active');
        });
      });
    }

    function initializePythonAnalysis() {
      const runBtn = document.getElementById("pythonRunBtn");
      const statusSpan = document.getElementById("pythonLiveStatus");
      const responseDiv = document.getElementById("pythonResponse");
      const filesUl = document.getElementById("pythonFiles");

      if (runBtn) {
        runBtn.addEventListener("click", async function(event) {
          event.preventDefault();

          const excelInput = document.getElementById("python-excel");
          if (!excelInput?.files?.length) {
            alert("Please select at least one Excel file");
            return;
          }

          runBtn.disabled = true;
          runBtn.textContent = "Processing...";
          statusSpan.textContent = "Processing‚Ä¶";
          responseDiv.innerHTML = "<p>üîÑ Processing files...</p>";

          const fd = new FormData();

          // Add Excel files
          for (const file of excelInput.files) {
            fd.append("excel_files", file);
          }

          // Add mapping file if selected
          const mappingInput = document.getElementById("mapping");
          if (mappingInput.files?.length > 0) {
            fd.append("mapping_file", mappingInput.files[0]);
          }

          // Add configuration parameters
          const configFields = [
            'materiality_vnd', 'recurring_pct_threshold', 'revenue_opex_pct_threshold',
            'bs_pct_threshold', 'recurring_code_prefixes', 'min_trend_periods',
            'gm_drop_threshold_pct', 'dep_pct_only_prefixes'
          ];

          configFields.forEach(field => {
            const input = document.getElementById(field);
            if (input && input.value) {
              fd.append(field, input.value);
            }
          });

          try {
            const response = await fetch('/process', { method: "POST", body: fd });

            if (response.ok) {
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = "variance_analysis_python.xlsx";
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);

              responseDiv.innerHTML = "<p>‚úÖ Processing completed! File downloaded.</p>";
              statusSpan.textContent = "Done";

              // NOW RUN REVENUE ANALYSIS AUTOMATICALLY
              console.log("üîç Starting automatic revenue analysis...");
              responseDiv.innerHTML += "<p>üîç Running revenue analysis...</p>";

              try {
                // Run comprehensive revenue analysis with the first uploaded file
                const firstFile = excelInput.files[0];
                if (firstFile) {
                  console.log("üìä Running revenue analysis for:", firstFile.name);

                  const revenueFormData = new FormData();
                  revenueFormData.append("excel_file", firstFile);

                  const revenueResponse = await fetch("/analyze-comprehensive-revenue", {
                    method: "POST",
                    body: revenueFormData
                  });

                  if (revenueResponse.ok) {
                    const revenueResult = await revenueResponse.json();
                    console.log("üìä Revenue analysis result:", revenueResult);

                    // FORCE DISPLAY RESULTS - Direct DOM manipulation
                    const resultsSection = document.getElementById("revenueResults");
                    const contentDiv = document.getElementById("revenueContent");

                    console.log("üîç DOM Check:", {
                      resultsSection: !!resultsSection,
                      contentDiv: !!contentDiv,
                      revenueResult: revenueResult
                    });

                    if (contentDiv && resultsSection) {
                      console.log("‚úÖ Both DOM elements found, setting content...");

                      contentDiv.innerHTML = `
                        <div style="border: 2px solid #4caf50; padding: 15px; margin: 10px 0; background: #f9fff9; border-radius: 8px;">
                          <h4 style="color: #2e7d32; margin: 0 0 10px 0;">üìä Revenue Analysis Results</h4>
                          <p><strong>Subsidiary:</strong> ${revenueResult.subsidiary || 'N/A'}</p>
                          <p><strong>Status:</strong> ‚úÖ Analysis Completed Successfully</p>
                          <p><strong>Accounts Found:</strong> ${revenueResult.summary?.total_accounts || 'N/A'}</p>
                          <p><strong>Latest Revenue:</strong> ${revenueResult.summary?.total_revenue_latest ? new Intl.NumberFormat('vi-VN').format(Math.round(revenueResult.summary.total_revenue_latest)) + ' VND' : 'N/A'}</p>
                          <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; font-weight: bold;">üìã Full Analysis Data</summary>
                            <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; overflow: auto; margin-top: 10px; font-size: 12px;">${JSON.stringify(revenueResult, null, 2)}</pre>
                          </details>
                        </div>
                      `;

                      resultsSection.style.display = "block";
                      resultsSection.style.background = "#fff";
                      resultsSection.style.border = "3px solid #4caf50";
                      resultsSection.style.borderRadius = "10px";
                      resultsSection.style.padding = "10px";

                      console.log("‚úÖ Revenue results displayed successfully!");

                      // Also try the external display function if it exists
                      if (typeof window.displayComprehensiveRevenueAnalysis === 'function') {
                        console.log("üé® Also calling external display function...");
                        try {
                          window.displayComprehensiveRevenueAnalysis(revenueResult);
                        } catch (e) {
                          console.error("External display function error:", e);
                        }
                      }
                    } else {
                      console.error("‚ùå Missing DOM elements:", {
                        resultsSection: !!resultsSection,
                        contentDiv: !!contentDiv
                      });
                      // Try to show error in response div
                      responseDiv.innerHTML += `<p>‚ùå Could not find display elements (resultsSection: ${!!resultsSection}, contentDiv: ${!!contentDiv})</p>`;
                    }

                    responseDiv.innerHTML += "<p>‚úÖ Revenue analysis completed!</p>";
                  } else {
                    const revenueError = await revenueResponse.json();
                    responseDiv.innerHTML += `<p>‚ö†Ô∏è Revenue analysis failed: ${revenueError.error}</p>`;
                  }
                } else {
                  responseDiv.innerHTML += "<p>‚ö†Ô∏è No file available for revenue analysis</p>";
                }
              } catch (revenueError) {
                console.error("Revenue analysis error:", revenueError);
                responseDiv.innerHTML += `<p>‚ö†Ô∏è Revenue analysis failed: ${revenueError.message}</p>`;
              }

            } else {
              const errorData = await response.json();
              responseDiv.innerHTML = `<p>‚ùå Error: ${errorData.error}</p>`;
              statusSpan.textContent = "Failed";
            }
          } catch (error) {
            responseDiv.innerHTML = `<p>‚ùå Network error: ${error.message}</p>`;
            statusSpan.textContent = "Failed";
          } finally {
            runBtn.disabled = false;
            runBtn.textContent = "Process";
          }
        });
      }
    }

    function initializeAIAnalysis() {
      const runBtn = document.getElementById("aiRunBtn");

      if (runBtn) {
        runBtn.addEventListener("click", function(event) {
          event.preventDefault();

          const excelInput = document.getElementById("ai-excel");
          if (!excelInput?.files?.length) {
            alert("Please select at least one Excel file");
            return;
          }

          const progressContainer = document.getElementById("aiProgressContainer");
          if (progressContainer) {
            progressContainer.style.display = "block";
          }

          runBtn.disabled = true;
          runBtn.innerHTML = 'üîÑ Processing...';

          const fd = new FormData();
          for (const file of excelInput.files) {
            fd.append("excel_files", file);
          }

          fetch('/start_analysis', { method: "POST", body: fd })
            .then(response => response.json())
            .then(data => {
              runBtn.innerHTML = 'ü§ñ AI Analyzing...';

              const eventSource = new EventSource(`/logs/${data.session_id}`);

              function updateProgress(percentage, stage, statusText) {
                const progressFill = document.getElementById("aiProgressFill");
                const progressPercentage = document.getElementById("aiProgressPercentage");
                const currentStatus = document.getElementById("aiCurrentStatus");

                if (progressFill) {
                  progressFill.style.width = percentage + "%";
                }
                if (progressPercentage) {
                  progressPercentage.textContent = percentage + "%";
                }
                if (currentStatus && statusText) {
                  const statusElement = currentStatus.querySelector('.status-text');
                  if (statusElement) {
                    statusElement.textContent = statusText;
                  }
                }

                // Update stage indicators
                const stages = ['upload', 'analyze', 'generate', 'complete'];
                stages.forEach((stageName) => {
                  const stageEl = document.getElementById("ai-stage-" + stageName);
                  if (stageEl) {
                    stageEl.classList.remove('active', 'completed');

                    if (stageName === stage) {
                      stageEl.classList.add('active');
                    } else if (stages.indexOf(stageName) < stages.indexOf(stage)) {
                      stageEl.classList.add('completed');
                    }
                  }
                });
              }

              eventSource.onmessage = function(event) {
                const logData = JSON.parse(event.data);

                if (logData.type === 'progress') {
                  let stage = 'upload';
                  if (logData.percentage >= 25 && logData.percentage < 85) {
                    stage = 'analyze';
                    runBtn.innerHTML = 'üß† AI Analyzing...';
                  } else if (logData.percentage >= 85 && logData.percentage < 100) {
                    stage = 'generate';
                    runBtn.innerHTML = 'üìä Generating Report...';
                  } else if (logData.percentage >= 100) {
                    stage = 'complete';
                  }

                  updateProgress(logData.percentage, stage, logData.message);
                } else if (logData.type === 'complete') {
                  updateProgress(100, 'complete', 'Analysis completed successfully!');
                  runBtn.innerHTML = '‚úÖ Complete!';
                  eventSource.close();

                  // Show download section
                  const downloadSection = document.getElementById("aiDownloadSection");
                  if (downloadSection) {
                    downloadSection.style.display = "block";

                    // Add main download button if not already present
                    if (!downloadSection.querySelector('.main-download-btn')) {
                      const mainDownloadBtn = document.createElement("button");
                      mainDownloadBtn.className = "btn primary main-download-btn";
                      mainDownloadBtn.innerHTML = "üìä Download AI Analysis Results";
                      mainDownloadBtn.style.marginBottom = "10px";
                      mainDownloadBtn.onclick = () => downloadMainResult(data.session_id);

                      const downloadTitle = downloadSection.querySelector('h3');
                      if (downloadTitle) {
                        downloadTitle.parentNode.insertBefore(mainDownloadBtn, downloadTitle.nextSibling);
                      }
                    }
                  }
                } else if (logData.type === 'error') {
                  updateProgress(0, 'upload', 'Error: ' + logData.message);
                  runBtn.innerHTML = '‚ùå Error';
                  eventSource.close();
                }
              };
            })
            .catch(error => {
              alert("Error: " + error.message);
              runBtn.disabled = false;
              runBtn.innerHTML = 'üöÄ Analyze with AI';
            });
        });
      }

      // Download function for AI analysis
      window.downloadMainResult = async function(sessionId) {
        try {
          const response = await fetch(`/download/${sessionId}`);
          if (!response.ok) {
            throw new Error(`Download failed: ${response.status}`);
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `ai_variance_analysis_${sessionId}.xlsx`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } catch (error) {
          alert("Download failed: " + error.message);
        }
      };
    }
  </script>

  <!-- Bump cache-buster when script changes -->
  <script src="/frontend/script.js?v=5" defer></script>
</body>
</html>